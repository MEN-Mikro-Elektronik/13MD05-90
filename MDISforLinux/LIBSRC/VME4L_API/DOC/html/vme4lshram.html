<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - VME4L API - Shared RAM support</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">VME4L API &nbsp; </h1>
	<h3>Shared RAM support</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1><a name="vme4lshram">Shared RAM support</a>
</h1>VME4L supports shared RAM of the VME bridge. Shared RAM is accessible both from VME and from the local user space application.<p>
It depends on the underlying bridge wether the shared RAM is a dedicated memory or a part of the system RAM. Each slave window corresponds to an VME4L space (see list below).<p>
By default, none of these windows are enabled. User has to call <a class="el" href="vme4l__api_8c.html#a33">VME4L_SlaveWindowCtrl()</a> to set the VMEbus address and occupied size of the window.<p>
After the window has been enabled, user can map the shared RAM into its application space:<p>
<div class="fragment"><pre>  <span class="comment">// Error checking omitted in this example</span>
<span class="preprocessor">  #include &lt;stdio.h&gt;</span>
<span class="preprocessor">  #include &lt;stdlib.h&gt;</span>
<span class="preprocessor">  #include &lt;string.h&gt;</span>
<span class="preprocessor">  #include &lt;stdint.h&gt;</span>
<span class="preprocessor">  #include &lt;signal.h&gt;</span>
<span class="preprocessor">  #include &lt;errno.h&gt;</span>
<span class="preprocessor">  #include &lt;unistd.h&gt;</span>
<span class="preprocessor">  #include &lt;<a class="code" href="vme4l_8h.html">MEN/vme4l.h</a>&gt;</span>
<span class="preprocessor">  #include &lt;<a class="code" href="vme4l__api_8h.html">MEN/vme4l_api.h</a>&gt;</span>

  <span class="keywordtype">int</span> main( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[] )
  {
      uint8_t *map;
      <span class="keywordtype">int</span> fd = <a class="code" href="vme4l__api_8c.html#a2">VME4L_Open</a>( VME4L_SPC_SLV3 );

      <span class="comment">// enable slave window, set vmeAddress to 0x400000 and size to 1MB</span>
      <a class="code" href="vme4l__api_8c.html#a33">VME4L_SlaveWindowCtrl</a>( fd, 0x400000, 0x100000 )

      <span class="comment">// map slave window into application space</span>
      <span class="comment">// note: the vmeAddr argument of VME4L_Map() is the offset within</span>
      <span class="comment">// the shared RAM here!</span>
      <a class="code" href="vme4l__api_8c.html#a13">VME4L_Map</a>( fd,
                  0,            <span class="comment">// offset</span>
                  0x100000,     <span class="comment">// size</span>
                  &amp;map)
      map[0] = 0x55;            <span class="comment">// write to first shared RAM cell</span>

  }
</pre></div><p>
A slave window can be disabled by calling <a class="el" href="vme4l__api_8c.html#a33">VME4L_SlaveWindowCtrl()</a> with a size of zero.<p>
Further notes to slave windows:<ul>
<li>More than one process can map the same window at the same time</li><li>The shared RAM area is marked non cacheable, so there is no extra flushing required by application</li></ul>
<p>
<dl compact><dt><b>Notes for VME-bridge on A13/A15:</b></dt><dd>The following assignment is used (only valid for PLD rev. &gt;=10)</dd></dl>
<div class="fragment"><pre>
  Space code       VME space  Local resource              Size
  --------------   ---------  --------------              -----------
  VME4L_SPC_SLV0   A16        Bridge control regs         4K
  VME4L_SPC_SLV1   A24        dedicated SRAM              64K..1M
  VME4L_SPC_SLV2   A32        dedicated SRAM              1M..256M
  VME4L_SPC_SLV3   A24        kernel memory               64K..1M
  VME4L_SPC_SLV4   A32        kernel memory               1M..256M
  </pre></div><p>
<ul>
<li>The VME address of each window must be aligned to its size (e.g. when size is 1MB, the VME address must be 1MB aligned)</li><li>VME4L_SPC_SLV1 and VME4L_SPC_SLV2 hit the same dedicated SRAM when accessed from VME.</li><li>VME4L_SPC_SLV3 and VME4L_SPC_SLV4 hit the same physical RAM when accessed from VME. This RAM is alloced from kernel memory and remains active until both windows are closed. The VME address or size of the window cannot be changed as long at is open. Please close it first.</li><li>Since the RAM for VME4L_SPC_SLV3 and VME4L_SPC_SLV4 will be allocated from kernel memory, Linux will limit the maximum size to 2MB typically. If this is not enough, you can only change this by recompiling the kernel with a different MAX_ORDER constant, see linux/mmzone.h: CONFIG_FORCE_MAX_ORDER for more info.</li><li>No HW swapping is provided by VME bridge</li><li>If your PLD revision is &lt; 10=, VME4L_SPC_SLV3 and VME4L_SPC_SLV4 are not available, and the size of VME4L_SPC_SLV1/VME4L_SPC_SLV2 is fixed to 1MB/256MB respectively.</li></ul>
<p>
<dl compact><dt><b>Notes for VME-bridge on A12/B11:</b></dt><dd>The following assignment is used:</dd></dl>
<div class="fragment"><pre>
  Space code       VME space  Local resource              Size
  --------------   ---------  --------------              -----------
  VME4L_SPC_SLV1   A24        dedicated SRAM              1M
  </pre></div><p>
<ul>
<li>The VME address of the window must be aligned to 1MB</li><li>No HW swapping is provided by VME bridge</li></ul>
<p>
<dl compact><dt><b>Notes for VME-bridge on A17/A19/A20:</b></dt><dd>The following assignment is used per default (settings can be adjusted in <a class="el" href="vme4l-tsi148_8h.html">vme4l-tsi148::h</a>)</dd></dl>
<div class="fragment"><pre>
  Space code       VME space  Local resource              Size
  --------------   ---------  --------------              -----------
  VME4L_SPC_SLV0   A16        TSI148 regs (GCSR)          4K
  VME4L_SPC_SLV3   A24        kernel memory               4K..16M
  VME4L_SPC_SLV4   A32        kernel memory               64K..4G
  VME4L_SPC_SLV5   A64        kernel memory               64K..16E
  </pre></div><p>
<ul>
<li>The VME address of each window must be aligned to its size (e.g. when size is 64KB, the VME address must be 64KB aligned).</li><li>Since the RAM will be allocated from kernel memory, Linux will limit the maximum size.</li><li>No HW swapping is provided by VME bridge. </li></ul>

	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for VME4L API using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2019 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

