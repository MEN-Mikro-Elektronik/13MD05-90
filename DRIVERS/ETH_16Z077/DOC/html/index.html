<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Linux native Driver for 16Z077/87 Ethernet IP cores - Linux native driver for Ethernet IP cores</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;"></a>
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Linux native Driver for 16Z077/87 Ethernet IP cores &nbsp; </h1>
	<h3>Linux native driver for Ethernet IP cores</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindexHL" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Linux native driver for Ethernet IP cores </h1>
<p>
The men_lx_z77(_sw).ko module serves as a Linux driver for the MEN FPGA IP cores 16Z077_ETH (10-Mbit HD only, obsolete) and 16Z087_ETH (10/100Mbit). The IP core 16Z087 is available e.g in the PPC based EM1 and the P511 PMC card. <br>
 The driver integrates seamlessly as a native network driver into the Linux kernels TCP/IP stack and can be accessed as a regular network device, e.g. eth1 (the assigned interface number may vary depending on already installed network cards). <br>
 <br>
 <h2><a name="install"></a>
Driver build and Installation</h2>
The driver is primarily designed to be used in conjunction with the MDIS system package for Linux. It is possible with some modifications to build the driver into the kernel but its primary intended use is to load it as a module.<h3><a name="kernver"></a>
Supported kernel versions and features</h3>
The driver was build tested with kernel versions 2.6.20 up to 3.6. Tests were done with kernels 2.6.22 (PPC), 2.6.32 (x86, Ubuntu 10.04) and 3.2.0 (x86, Ubuntu 12.04). The most important features are:<ul>
<li>Support for IEEE 802.1q VLAN tagging (kernel must be enabled for it)</li><li>Support for Multicast MAC addresses (tool ipmaddr can be used to apply addresses)</li><li>verbose reporting when message level set with ethtool</li></ul>
<h3><a name="builddrv"></a>
Building the driver</h3>
The driver can be built either as part of an ELinOS project (for MEN PowerPC CPUs) or to run as a self-hosted project (on x86 desktop or cPCI PCs). The driver depends on the Chameleon FPGA base driver, which is named <code>men_lx_chameleon.ko</code> (The ethernet driver registers itself using the base driver, so the module <code>men_lx_chameleon.ko</code> has to be loaded too or must be built statically into the kernel). <br>
 the MDIS system package for Linux is needed to build and use the driver. The drivers package 13z07790.zip can be added to the MDIS Wizard like any other driver package. It can be applied to any carrier or ESM that is equipped with a Chameleon FPGA, e.g. ESMs EM7 or EM1.<br>
<p>
<dl compact><dt><b>Warning:</b></dt><dd>The label ETH_1 assigned in the MDIS Wizard is just for maintenance purposes in the generated <code>system.dsc</code> file. The device cannot be used with MDIS utilities! trying something like <code>m_open</code> <code>eth_1</code> will cause an error.<br>
 <br>
</dd></dl>
<h3><a name="loaddrv"></a>
Loading the driver</h3>
In case of the PMC module P511 the driver can operate either on a PowerPC based CPU like the MEN D3C or with a x86 based board like the F14 (together with a PMC carrier). The difference here is that the kernel module will be named according to the endianness of the used CPU. The driver will be named<br>
<ul>
<li><code>men_lx_z77_sw.ko</code> on big endian architectures (PowerPC, e.g. EM1)<br>
</li><li><code>men_lx_z77.ko</code> on little endian architectures (x86, e.g. F14)<br>
 <br>
</li></ul>
<p>
When all MDIS modules have been built successfully, they are installed into the default path for kernel modules, typically in <br>
 /lib/modules/`uname -r`/misc/. The command 'uname -r' returns the currently used kernel version, see section Troubleshooting. When installation is done using the MDIS Wizard, the modules are all in place and module dependencies have been updated.<br>
 For the P511 the procedure is similar, the driver is either built as an ElinOS MDIS Project or a self-hosted MDIS project. Typically a self-hosted MDIS project is used when the P511 is operating on the same x86 CPU.<br>
 Now the driver can be loaded via the modprobe command, here shown with all parameters for a P511 together with F14 CPU:<br>
 <div class="fragment"><pre>
 #&gt; modprobe men_lx_z77 phyadr=0,1 nodma=0 mode=AUTO
MEN ETH driver built Feb  5 2009 17:07:20
passed PHY mode: 'AUTO'
found 16Z087 (phys 0xfbffe300 irq 0x3 base addr 0xe003e300 )
eth2: 16Z087 found at 0xe003e300
passed PHY mode: 'AUTO'
found 16Z087 (phys 0xfbffe400 irq 0x3 base addr 0xe0050400 )
eth3: 16Z087 found at 0xe0050400
</pre></div><br>
 When used on the EM1, the <code>modprobe</code> command looks like <div class="fragment"><pre>
 #&gt; modprobe men_lx_z77_sw phyadr=1 mode=AUTO
MEN ETH driver built Feb  5 2009 17:07:20
passed PHY mode: 'AUTO'
found 16Z087 (phys 0xfbffe300 irq 0x3 base addr 0xff039000 )
eth1: 16Z087 found at 0xff039000
</pre></div><p>
On the EM1 or other PowerPC CPU the loaded modules list should now look like this: <div class="fragment"><pre>
 #&gt; lsmod
 Module                  Size  Used by    Not tainted
 men_lx_z77_sw          23956  0
 men_lx_chameleon        5016  1 men_lx_z77_sw
 men_chameleon          10640  1 men_lx_chameleon
 men_oss                16112  2 men_lx_chameleon,men_chameleon
</pre></div><h3><a name="phyint"></a>
PHY interface settings</h3>
The default mode for the PHY interface is AUTO, which means the communication settings are handled with the partner interface by autonegotiation. See the kernel parameters below to see how other fixed values can be passed to the driver.<h3><a name="usage"></a>
Driver usage and interaction with standard tools</h3>
The driver supports all standard tools like ifconfig and ethtool. This way all information about the link status and number of received and transmitted packets can be retrieved. <br>
 <br>
<h2><a name="modparm"></a>
Available module parameters</h2>
The driver supports the following parameters, which can be retrieved with the <code>modinfo</code> command: <div class="fragment"><pre>
/# modinfo men_lx_z77
filename:       /lib/modules/2.6.22.18-ELinOS-486/misc/men_lx_z77.ko
license:        GPL
description:    MEN Ethernet IP core unit driver
author:         thomas.schnuerer@men.de
vermagic:       2.6.22.18-ELinOS-486 mod_unload 486 
depends:        men_lx_chameleon
parm:           nodma:0: standard (DMA) function 1: P511 (no DMA) mode (int)
parm:           phyadr:Address of PHY connected to each Z87 unit (array of int)
parm:           mode: AUTO,10HD,10FD,100HD,100FD. default: AUTO (charp)
parm:           dbglvl: debug level 0..3 (none..very verbose) (int)
</pre></div><p>
<ul>
<li><code>mode</code> <br>
 This is the initial PHY interface mode that shall be used upon starting the network interface. Valid values are <div class="fragment"><pre>
	mode=10HD	Force PHY Mode to 10 Megabit half duplex
	mode=10FD	Force PHY Mode to 10 Megabit full duplex
	mode=100HD	Force PHY Mode to 100 Megabit half duplex
	mode=100FD	Force PHY Mode to 100 Megabit full duplex
	mode=AUTO	Let Phy autonegotiate its settings   (default setting) 

	usage for multiple instances, when multiple Z87 cores are found:

	mode=100FD,AUTO		force 1st Phy to 100 Mbit full duplex, 2nd Phy to Autoneg.

</pre></div>e.g. <code>modprobe</code> <code>men_lx_z77_sw</code> <code>mode=100FD</code> <br>
 <b>Attention</b>: for the P511 the passed <code>mode</code> parameter is assigned to both PHYs.</li></ul>
<p>
<ul>
<li><code>nodma</code> (P511 only!) <br>
 when passed as 1, the P511 does <b>not</b> use PCI DMA data transfer but stores the Ethernet frames locally in the P511 SDRAM. Then the driver has to transfer the frame data in programmed mode which significantly decreases the transfer rate from about 10 MB/s at 100Mbit mode to around 1,8 MB/s. <br>
 <div class="fragment"><pre>
	nodma=0		standard PCI DMA transfer of Ethernet data    (default setting)
	nodma=1		no PCI DMA, frames stored locally on P511
</pre></div>e.g. <code>modprobe</code> <code>men_lx_z77_sw</code> <code>nodma=1</code>  <dl compact><dt><b>Warning:</b></dt><dd>this mode is used only in special applications where it is desired to have full control over system activity. For all other purposes the parameter can be omitted. <br>
</dd></dl>
</li><li><code>dbglvl</code> <br>
 The debug level is identical to the msglvl parameter passed in the ethtool command. It allows to enable verbose debugging at driver load time.<br>
</li></ul>
<p>
<div class="fragment"><pre>
	dbglvl=0	no debug outputs, driver runs with maximum performance. (default setting)
	dbglvl=1	basic debugging, function entry and leave debugs are shown.
	dbglvl=2	verbose debugging, like level 1 plus frame send/receive messages.
	dbglvl=3	very verbose debugging, like level 2 plus IRQ and sent/received frame debugs.
</pre></div><p>
<dl compact><dt><b>Warning:</b></dt><dd>debug levels 2 and 3 decrease driver performance noticable. They should be used only for hardware debugging</dd></dl>
<br>
<p>
<ul>
<li><code>phyadr</code> <br>
 Address of PHYs connected to each 16Z087- unit. This parameter tells the driver the PHY address (a value between 0 and 31) of each found instance of the IP core. This parameter is determined by the hardware and therefore fixed. For the P511 this parameter <b>must</b> be passed as <code>phyadr=0</code>,1. For the EM1 the parameter <b>must</b> be passed as 1. <div class="fragment"><pre>
	phyadr=0,1	PHY addresses of 1st and 2nd P511 Ethernet IP core instance
	phyadr=1	PHY address of the Micrel KS8721 PHY on the EM1
</pre></div></li></ul>
<p>
Keep in mind that the connection is not set up on driver load time but when the interface is brought up using <code>ifconfig</code> !<h3><a name="etht_link"></a>
Retrieving link status information</h3>
Since the necessary support functions for ethtool are used in the driver, the link status can be retrieved as shown in this example. The interface name used here (eth0) may vary on your system.<p>
<div class="fragment"><pre>
/# ethtool eth0
Settings for eth0:
        Supported ports: [ TP MII ]
        Supported link modes:   10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
        Supports auto-negotiation: Yes
        Advertised link modes:  10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
        Advertised auto-negotiation: Yes
        Speed: 100Mb/s
        Duplex: Full
        Port: MII
        PHYAD: 1
        Transceiver: internal
        Auto-negotiation: on
        Current message level: 0x00000000 (0)
        Link detected: yes
</pre></div><p>
<br>
<h2><a name="vlan"></a>
VLAN support</h2>
<br>
<p>
The driver supports IEEE 802.1Q VLAN (virtual LAN) tagging to setup several virtual LANs in one physical connection. For this the used kernel must be enabled for VLAN support. Either <code>CONFIG_VLAN_8021Q</code> must be set in the kernel configuration or the kernel module 8021q.ko must be loaded prior to using VLAN.<br>
<h3><a name="vconfig"></a>
using vconfig to instantiate a VLAN</h3>
To instantiate one or more VLAN connections, the linux utility <code>vconfig</code> must be present on the target. For detailled usage check the manpage of <code>vconfig</code>. Here a short example is shown how to instantiate a VLAN with ID 810. If the physical Z87 core is named eth0 on the target, the VLAN can be generated with <div class="fragment"><pre> root@men-desktop:/home/men/f11mdis# vconfig add eth0 810
Added VLAN with VID == 810 to IF -:eth0:- </pre></div>and an IP address can be assigned with the <code>ifconfig</code> tool in the regular way: <br>
 <br>
 <code>ifconfig</code> <code>eth0</code>.810 <code>10</code>.1.1.88 <br>
<h3><a name="vlanprio"></a>
Setting VLAN priority values</h3>
The VLAN contains a 3-bit field named PCP in which a priority for the data can be specified. This value can be set also with the vconfig tool. To assign a value of 4 to frames with socket buffer priority 0, the egress and ingress parameter of vconfig is used: <br>
 <code>vconfig</code> <code>set_egress_map</code> <code>eth0</code>.810 <code>0</code> <code>4</code> <br>
 <br>
<p>
When the VLAN ID and priority value is set like above, the generated VLAN frame can be shown like in the following example.<br>
 Mind that there the physical interface eth0 is used, not the VLAN interface eth0.810. This is because the VLAN instance of the interface does not support the ethtool calls to set the message levels. In the frame dump the resulting VLAN tag <code>81</code> <code>00</code> <code>83</code> <code>2a</code> can be seen. (0x8100 = VLAN header, 0x832a = PCP value 4, VLAN ID 0x32a (810). <div class="fragment"><pre> 
root@men-desktop:/home/men/f11mdis# ethtool -s eth0 msglvl 3; ping 10.1.1.20 -c 3; ethtool -s eth0 msglvl 0
root@men-desktop:/home/men/f11mdis# dmesg
...
[ 5016.897073] z77_send_packet[15] len 0x002a DMAadr 36b9f000
[ 5016.897097] VLAN frame: np-&gt;vlgrp = ef503580  vlan_id = 0x832a  vlan_tag = 0x2a830081
[ 5016.897201] 0x000: ff ff ff ff ff ff 00 c0 3a ff 00 01 81 00 83 2a 
[ 5016.897261] 0x010: 08 06 00 01 08 00 06 04 00 01 00 c0 3a ff 00 01 
[ 5016.897320] 0x020: 0a 01 01 58 00 00 00 00 00 00 0a 01 01 14 
[ 5016.897401] Z77 INTSRC: 01 [TXB]
[ 5016.897517] Z77 INTSRC: 04 [RXF]
[ 5016.897538] --&gt; z77_poll:
[ 5016.897558] z77_pass_packet[34]: pktlen=0040
[ 5016.897568] Frame:
[ 5016.897578] 0x000: 00 c0 3a ff 00 01 00 30 05 ad 55 e1 81 00 03 2a 
[ 5016.897635] 0x010: 08 06 00 01 08 00 06 04 00 02 00 30 05 ad 55 e1 
[ 5016.897693] 0x020: 0a 01 01 14 00 c0 3a ff 00 01 0a 01 01 58 00 00 
[ 5016.897753] 0x030: 00 00 00 00 00 00 00 00 00 00 00 00 5a e6 f6 c0 
[ 5016.897823] &lt;-- z77_poll:
...
</pre></div><h2><a name="trouble"></a>
Troubleshooting</h2>
If you have problems using the driver check the following points before contacting MEN support:<p>
<ul>
<li>Problems regarding module load<ul>
<li>Does the version of the built modules match the running kernel? This can happen on self-hosted build environments with several kernel sources installed in /usr/src/. Execute e.g. the commands <code>modinfo</code> <code>men_lx_z77</code> and <code>uname</code> <code>-a</code> to see if the versions match.</li><li>Have the module dependencies been updated? Run the <code>depmod</code> command to rebuild the module dependencies file if an 'unresolved symbols' error occurs.</li></ul>
</li></ul>
<p>
<ul>
<li>Problems with Ethernet communication<ul>
<li>If no communication seems to occur check if the link status changes when plugging the network cable in and out.</li><li>Try to use the ping command to reach the external communication partner.</li><li>Check if the interrupt count increases as ping commands are sent. The proc file /proc/interrupts can be used to do this: <div class="fragment"><pre>
/#cat /proc/interrupts
           CPU0
  5:        539   MPC52xx   Level     16Z087
 39:      20425   MPC52xx   Level     mpc52xx_psc_uart
 53:      10121   MPC52xx   Level     i2c-mpc
 54:        140   MPC52xx   Level     i2c-mpc
BAD:          0
</pre></div></li><li>If the status LEDs work properly but the device eth(x) is inaccessible: check if the IP cores inside the P511 FPGA were found. Run the <code>dmesg</code> command (or do <code>cat</code> <code>/var/log/messages</code>) to see if the <code>men_lx_chameleon</code> driver detected the IP cores. As an example the output of the <code>dmesg</code> command on the used test system with a P511 looks like this: <div class="fragment"><pre>
 Init MEN Chameleon PNP subsystem. Build: Feb  5 2009 / 17:07:19

 Found MEN Chameleon FPGA at bus 4 dev 0d
 FPGA File='' table model=0x41('A') Revision 0 Magic 0xABCE
  Unit                devId   Grp Rev    Inst	IRQ	BAR Offset   Addr
 -------------------------------------------------------------------------------
  00 16Z024_SRAM      0x0018  0   17   0x00	0x3f	0   0x0000   0xfbffe000
  01 16Z045_FLASH     0x002d  0    4   0x00	0x3f	0   0x0100   0xfbffe100
  02 16Z001_SMB       0x0001  0    8   0x00	0x00	0   0x0200   0xfbffe200
  03 16Z087_ETH       0x0057  0    6   0x00	0x01	0   0x0300   0xfbffe300
  04 16Z087_ETH       0x0057  0    6   0x01	0x02	0   0x0400   0xfbffe400
  05 16Z034_GPIO      0x0022  0   16   0x00	0x03	0   0x0500   0xfbffe500
  06 16Z084_IDEEPROM  0x0054  0    2   0x00	0x3f	0   0x0600   0xfbffe600
  07 16Z052_GIRQ      0x0034  0    6   0x00	0x3f	0   0x0700   0xfbffe700
  08 16Z043_SDRAM     0x002b  0    9   0x00	0x3f	1   0x0000   0xf8000000
</pre></div>Here the Units number 3 and 4 represent the 2 Ethernet cores. The Unit 8 is the SDRAM controller which stores Ethernet frames locally if parameter <code>nodma</code> is set. <br>
</li></ul>
</li></ul>
<h3><a name="ethtool"></a>
Switching on message level</h3>
To get detailed information about called procedures in the driver, the debugging message level can be increased to a value up to 3 using the <code>msglvl</code> command of ethtool. The values have the following meaning:<ul>
<li>msglvl 0: all messages disabled, normal function</li><li>msglvl 1: only some function entries are shown</li><li>msglvl 2: more detailed messages</li><li>msglvl 3: maximum detailed messages including the driver's interrupt service routine and sent / received ethernet frames</li></ul>
<p>
The following example shows how to enable the debug messages:<p>
<div class="fragment"><pre>
/#ping 10.1.1.10
PING 10.1.1.10 (10.1.1.10): 56 data bytes
84 bytes from 10.1.1.10: icmp_seq=0 ttl=64 time=87.1 ms
84 bytes from 10.1.1.10: icmp_seq=1 ttl=64 time=0.2 ms
84 bytes from 10.1.1.10: icmp_seq=2 ttl=64 time=0.2 ms
84 bytes from 10.1.1.10: icmp_seq=3 ttl=64 time=0.2 ms
84 bytes from 10.1.1.10: icmp_seq=4 ttl=64 time=0.2 ms

--- 10.1.1.10 ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max = 0.2/17.5/87.1 ms

/#ethtool -s eth0 msglvl 3
/#
/#ping 10.1.1.10
PING 10.1.1.10 (10.1.1.10): 56 data bytes
[19773.315172] z77_send_packet[30] len 0x0076 DMAadr 06d10000
[19773.324083] Z77 INTSRC: 01 [TXB]
[19773.327288] Z77 INTSRC: 04 [RXF]
[19773.330493] --&gt; z77_poll:
[19773.333086] z77_pass_packet[1]: pktlen=007a
[19773.337258] &lt;-- z77_poll:
84 bytes from 10.1.1.10: icmp_seq=0 ttl=64 time=24.8 ms
[19774.342014] z77_send_packet[31] len 0x0076 DMAadr 06d16000
[19774.347481] Z77 INTSRC: 01 [TXB]
[19774.350688] Z77 INTSRC: 04 [RXF]
[19774.353886] --&gt; z77_poll:
[19774.356477] z77_pass_packet[2]: pktlen=007a
[19774.360649] &lt;-- z77_poll:
84 bytes from 10.1.1.10: icmp_seq=1 ttl=64 time=21.3 ms

--- 10.1.1.10 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 21.3/23.0/24.8 ms
</pre></div><br>
 <br>
 <br>
 <h2><a name="addinfo"></a>
Additional information sources about network utilities</h2>
For more information about the network configuration commands like <code>ethtool</code>, <code>ifconfig</code> and <code>ping</code> see the manual pages that can be displayed with the <code>man</code> command. It shows all available options and usage info about a command. <div class="fragment"><pre>
tschnuer@tslinux2:~/work&gt; man ethtool

ETHTOOL(8)

NAME
       ethtool - Display or change ethernet card settings
[...]
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Linux native Driver for 16Z077/87 Ethernet IP cores using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2014 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

